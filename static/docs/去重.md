# 目标

下载文件前查询之前的下载记录，进行去重。

考虑命名规则。一个文件如果前后两次下载时，命名规则一致则判断为重复。命名规则不一致则认为不重复。

需要增加开关：

- 启用去重
- 去重策略？松散 严格 同一文件使用不同文件名，是否认为是重复
- 清空去重数据？可以考虑不做清除功能

# 数据的存储方式：

## 数据库

去重数据（其实就是下载记录）单独存储在一个 IndexedDB 数据库中。

浏览器的本地存储的额度控制参考这里：

https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Browser_storage_limits_and_eviction_criteria

根据这里面的说法，如果本地存储占据的硬盘空间达到上限，浏览器会依次清理掉最久没有被使用的源的数据。似乎一个域名就是一个源（子域名不同则视为不同的网站）。浏览器清理存储空间的时候是按源为单位的，所以如果清理到 pixiv.net 的话，其下所有数据库都会被删除。

## 表

每下载成功一个文件，添加它对应的下载记录。例如：

```
{
  id:'82666025-0',
  name:'{p_title}/{id}-{user}-{tags_translate}'
}
```

`id` 字段是把作品 id 和作品类型连接起来了。

`name` 字段是命名规则。这里不保存实际生成的文件名，只保存命名规则。这是为了节约存储空间。

上面的例子中，假设一条数据占据的存储空间为 `60 B` 左右，那么 `1 GiB` 空间可以存储约 `1800 w` 条记录。已经很多了。
